"""
CVE 2016 2870
"""
from constants import MEDIUM_RELIABILITY, UBUNTU_12_LTS, UBUNTU_14_LTS, UBUNTU_15, POTENTIALLY_VULNERABLE, \
	DEBIAN_7, DEBIAN_8, color_print
from src.kernels import KernelWindow
from exploits.exploit import Exploit

class CVE20157547(Exploit):
	def __init__(self):
		super().__init__()
		self.name = "CVE-2015-7547"
		self.type = "linux"
		self.brief_desc = "stack-based buffer overflows in glibc < 2.23 can cause privilege escalation"
		self.reliability = MEDIUM_RELIABILITY
		self.vulnerable_kernels = [
			KernelWindow(UBUNTU_15, POTENTIALLY_VULNERABLE, 0, 0, 0, 4, 0, 0),
			KernelWindow(UBUNTU_14_LTS, POTENTIALLY_VULNERABLE, 0, 0, 0, 4, 0, 0),
			KernelWindow(UBUNTU_12_LTS, POTENTIALLY_VULNERABLE, 0, 0, 0, 4, 0, 0),
			KernelWindow(DEBIAN_7, POTENTIALLY_VULNERABLE, 0, 0, 0, 4, 0, 0),
			KernelWindow(DEBIAN_8, POTENTIALLY_VULNERABLE, 0, 0, 0, 4, 0, 0)
		]

	def determine_vulnerability(self):
		color_print("\t[*] checking exploitation prerequisites for {}".format(self.name), color="blue")
		# we need to check the glibc version < 2.23
		color_print("\t[*] checking glibc version is < 2.23")
		glibc_version_stdout = self.shell_results("ldd --version")[0].decode('utf-8')
		if len(glibc_version_stdout) == 0:
			self.exploit_failure("could not determine glibc version")
			return False
		glibc_version = glibc_version_stdout.split("\n").split(" ")[-1]
		v_major = int(glibc_version.split(".")[0])
		v_minor = int(glibc_version.split(".")[1])
		if v_major <= 2:
			if v_minor < 23:
				color_print("\t[+] system appears to be vulnerable to {}".format(self.name), color="green")
				return True

		self.exploit_failure("glibc version {} not < 2.23".format(glibc_version))
		return False
